---
title: Vim使用指北
tags:
  - 文本编辑器
excerpt: Vim，编辑器之神是也。
toc: true
author: xeonds
date: '2021.06.19 15:43:16'
categories:
  - 计算机科学
---

## 0x0.简介

这是一个几乎所有Linux发行版都会自带的，（比较）轻量级的，功能强大的恰到好处的文本编辑器。

因为其功能极度强大，所以人赐外号：“编辑器之神”。

不过，因为它的一切操作只依靠键盘，所以对于用习惯GUI的朋友们而言，不太友好。~~在谷歌上输入How to quit，联想结果的第一个就是How to quit vim（~~相对其他几个编辑器而言，它的学习曲线还是比较适中的。初学的时候记下几个快捷键，用熟了再继续慢慢学，不知不觉就能用得越来越爽了。

要想用好Vim，就离不开下面这几个关键点：

* 快捷键（核心）
* 配置文件（用得更爽）
* 插件（？）
* 帮助文档（！），输入`:help`即可查看

## 0x01.基础操作

假定你在用任意一个Linux发行版（Windows需要单独下载），根据下面的步骤来尝试Vim吧。

首先，在命令行中输入`vim`，进入Vim。也可以输入`vim filename`来编辑一个现存的文件，或者创建并编辑一个新的文件。

进入Vim后，按键盘上的`i`以进入编辑模式。此时，最下方的状态指示变为`INSERT`，即插入模式。这时，我们可以像使用其他文本编辑器一样使用Vim，不过只能用键盘输入、删除和移动光标，并且不能用`Ctrl+Z/C/V`等组合键，它们不仅没有作用，有的还会终止编辑器使得你丢失编辑进度。

输入完毕后，按一下键盘左上角的`Esc`，退出编辑模式。随后，输入`:`（即英文冒号）进入命令模式，此时输入的命令在最底下的状态栏显示。接着，输入`wq`保存并退出vim。除了用`:wq`保存并退出，也可以按`ESC`之后直接输入`ZZ`(大写)来保存并退出。

这就是Vim的基本使用，现在可以尝试用它进行最基础的文件编辑。

## 0x02.常用操作与技巧

### 字符替换

Vi/Vim 中可以使用 :s 命令来替换字符串。以前只会使用一种格式来全文替换，今天发现该命令有很多种写法（vim 真是强大啊，还有很多需要学习的），记录几种在此，方便以后查询。

`:s/vivian/sky/` 替换当前行第一个 vivian 为 sky
`:s/vivian/sky/g` 替换当前行所有 vivian 为 sky
`:n,$s/vivian/sky/` 替换第 n 行开始到最后一行中每一行的第一个 vivian 为 sky
`:n,$s/vivian/sky/g` 替换第 n 行开始到最后一行中每一行所有 vivian 为 sky

>n 为数字，若 n 为 `.` 则表示从当前行开始到最后一行

`:%s/vivian/sky/`（等同于 `:g/vivian/s//sky/`） 替换每一行的第一个 vivian 为 sky
`:%s/vivian/sky/g`（等同于 `:g/vivian/s//sky/g`） 替换每一行中所有 vivian 为 sky

### Visual模式

Vim的使用场景一般都是SSH连接到无头服务器上。那种情况一般没有GUI，也没有鼠标。难道就不能像在Windows里一样用鼠标拖拽选择文字了？仍然可以，借助V模式即可。

V模式，也就是可视化模式，在按`ESC`退出编辑模式后，按`v`即可进入。此时，状态栏会显示`--VISUAL--`，这时用方向键/HJKL移动光标则会从当前位置“拖拽”选择文字，并且此时也一样支持`gg/G`、`:n`、`n+方向键/HJKL`来快速移动光标。此时再按一次`v`即可退出V模式。

进入V模式后，选择了需要编辑的内容之后，使用`x`可以剪切被框选的内容，`y`则可以复制区域内容，用`p`可以粘贴内容并覆盖所选区域；除此之外，**用`"+y`则可以复制内容到系统剪贴板**，**用`"+p`可以从系统剪贴板粘贴**。注意这快捷键前的双引号是必须的。

>如果需要多次复制粘贴内容，需要在`~/.vimrc`添加如下配置来直接同步系统剪贴板和Vim剪贴板：
>
>```vimrc
>set clipboard=unnamedplus
>```

借助V模式，不用鼠标也能选取文字、复制粘贴。更详细的用法可以阅读Vim的help手册。

### 分屏与文件浏览

使用vim时，用`vim [filename]`就可以打开/创建并编辑一个文件，不过`filename`也可以是目录名称，这样就会用vim内置的文件管理器打开目标目录。这个模式使用起来很简单，上下键移动光标，回车键确认。

分屏也是一个实用操作，不过学了tmux之后我就不怎么用vim的分屏操作了。

核心快捷键只有两组：`Ctrl+w,h/v`和`Ctrl+w,h/j/k/l`。第一组是分屏，`h`表示水平分屏，`v`表示垂直分屏。第二组快捷键表示在各个分屏中移动，`h/j/k/l`和vim默认模式的含义一样，表示向左/下/上/右移动。

另外，也可以通过`:sp/vsp [filename]`来水平/垂直分屏并打开名为`filename`的文件。

关闭分屏和关闭文件一样，选择当前分屏，用`:q/wq(!)`和`ZZ`都可以退出（并保存）当前文件。

### 命令模式

在vim中也能直接和CLI交互，使用`:![command]`即可。其中，`%`表示当前文件的文件名。通过这个方法，我们可以快速调试单文件程序，例如：

```bash
:w    # 一定记得先保存当前文件再编译
:!gcc % && ./a.out
```

在命令模式输入上述代码，即可编译并运行当前文件。同时，命令模式也支持上下键回溯历史命令。

编写脚本时，借助它能够快速验证/执行脚本。

### Ctrl+r

这是一个常用的插入快捷键，用于在insert模式下插入各种内容。下面用`<C-r>`表示`Ctrl+r`。

#### 插入寄存器中的内容

在vim中，寄存器用于存储文本。您可以使用以下命令将寄存器中的内容插入到当前位置：

```vim
<C-r>{register}
```

其中，`{register}`是要插入内容的寄存器名。例如，`<C-r>0`将插入0号寄存器中的内容。

#### 插入表达式的结果

您可以使用以下命令将表达式的结果插入到当前位置：

```vim
<C-r>= {expression} <CR>
```

其中，`{expression}`是要求值的表达式。例如，`<C-r>=2+2<CR>`将在当前位置插入“4”，`<C-r>=strftime('%c')<CR>`可以插入当前日期。

#### 插入文件名

如果您希望将文件名插入到当前位置，可以使用以下命令：

```vim
<C-r>%
```

这将在当前位置插入当前文件的名称。

#### 插入上一次插入的文本

如果您需要在插入模式下重新插入上一次插入的文本，可以使用以下命令：

```vim
<C-r>"
```

这将在当前位置插入最后一次插入的文本。

### 高效编辑

这一部分比较杂，包含一些快捷操作。

#### 插入删除

- `x` 删除当前字符
- `i` 在光标前插入
- `a` 在光标后插入
- `o` 在当前行后另起一行插入
- `O` 在当前行前另起一行插入

#### 快速跳转

-  `:[line number]` 快速跳转到目标行号
- `w` 向后跳转一个单词
- `gg` 跳转到全文开头，`G` 跳转到全文末
- `0` 跳转到当前行初，`$` 跳转到当前行末
- `/[keyword]` 搜索并跳转到`keyword`处，`n` 继续向后搜索，`N` 向前搜索
- `n+h/j/k/l` 向前/下/上/后跳转n单位
- `ctrl+i` 跳转到上一个历史位置
- `ctrl+o` 跳转到下一个历史位置
- `gi` 跳转到上一次编辑的位置
- `[number]G` 跳转到第`number`行，和`:number`效果一样

除了上面那些操作，Vim还提供了很多移动功能。比如浏览一些可以折叠的代码块时，可以用下面的命令展开和折叠：

```vim
zM      "折叠代码块
zf[n]G  "折叠当前行到第n行
zE      "删除所有的折叠标签（被折叠的区域会有大括号作为提示）
zR      "展开代码块
```

这部分的内容，详细可以看Vim的帮助文档。输入`:h Folding`即可查看。

#### 复制粘贴

- `dd` 删除当前行，`ndd` 删除从当前行往后的n行，`dn+h/l` 删除光标前/后n个字符
- `yy` 复制当前行，`nyy` 复制从当前行往后的n行，`yn+h/l` 复制光标前/后n个字符
- `p` 粘贴复制的内容

#### 重复操作（宏）

这是Vim中最强大的功能之一。在处理较多数据的时候，真的能节省大量的时间。

- `q+[letter]` 进入操作记录模式，随后除了 `q`的所有按键都会被记录
- `q` 退出操作录制模式并保存之前的操作到`letter`
- `@[letter]` 重复录制的操作，`n@[letter]` 重复n次录制的操作

举个例子吧。比如我想删掉每行行末的两个字符，我就可以这么用：

```vim
Esc+gg    "跳转到开头
qq        "开始录制宏到q中
$,xx,j    "逗号表示隔开的操作。它表示先跳转到行末，然后删除两个字符，再跳到下一行
q         "停止并保存宏到q
```

这样就完成录制了。随后移动光标到你编辑的起始位置，并输入`n@q`来批量操作，其中的`n`表示你需要重复操作的次数。

随后，欣赏魔法吧（雾

在录制宏的时候，尽量用相对定位，例如`0`和`$`（行首和行末），同时尽量先确认操作是能达到效果的，不然自动机乱飞就不好玩了（其实误操作也能用`u`救回来

### Bin编辑

用`Esc+:`进入命令模式后，输入`%!xxd`就可以用二进制模式查看文件。

要返回正常模式，只需要输入`%!xxd -r`即可返回。

>jyy好强（

### 输出重定向到Vim

```bash
strace -f gcc a.c |& vim -
```

上面的管道符将`strace`的输出（`stdin`）重定向到了Vim中，便于我们查看和编辑。

### Vim+grep

在Vim命令模式中可以这样使用grep：

```bash
:%!grep execve      # 提取出含有execve的行
:%!grep -v ENOENT   # 过滤掉含有ENOENT的行
```

这对buffer中的数据调用命令行进行处理，并替换（？）Vim Buffer中的内容。实质上和上面的Bin编辑类似（？）。

## 0x03.配置文件

一般指的是用户目录下的`.vimrc`文件。Vim启动时会自动读取并加载它。它的内容主要包含Vim设置项，自定义函数等。

下面是一份示例配置文件。

```vimrc
"这是注释，以英文双引号开头

syntax enable
syntax on

set tabstop=4
set shiftwidth=4
set autoindent
set smartindent
set ignorecase
set cindent
set shiftround
set encoding=utf-8
set number
set ruler
set hlsearch
set laststatus=2
"set showmatch
"set cursorline
highlight StatusLine guifg=SlateBlue guibg=Yellow

let g:netrw_winsize=30
let g:netrw_liststyle=1
let g:netrw_timefmt='%Y-%m-%d %H:%M:%S'

filetype plugin on

map <F5> :call PRUN()<CR>
nmap <F6> :Sexplore!<CR>
inoremap <TAB> <C-R>=InsertTabWrapper()<CR>

func! PRUN()
 exec "w"
 if &filetype == 'python'
  exec "!python %"
 elseif &filetype == 'c'
  exec "!gcc % && ./a.out && rm ./a.out"
 endif
endfunc

func! InsertTabWrapper()
 let col=col('.')-1
 if !col || getline('.')[col-1] !~ '\k'
  return "\<TAB>"
 else
  return "\<C-N>"
 endif
endfunc
```

Vim配置文件的路径在当前用户目录下，也就是`/home/usrname/.vimrc`，不同的用户都有各自的配置文件。

### 配置结构

前两行是开启代码高亮和语法分析。第一大块主要是和缩进有关，前四行都是缩进设置，后几行分别是搜索时忽略大小写，启用C语言语法缩进，`shiftround`是啥来着忘了(

下一个小块（只有一行）是设置编码为`utf-8`。

下一个大块基本是界面显示相关设置。第一行是开启行号显示，第二行没啥用给注释掉了，第三行是显示当前光标在第几行第几列，第四行是高亮被搜索的关键字，下一行是在当前行显示下划线，用不上所以我注释掉了。下一行是显示编辑状态栏，再下一行是设置状态栏样式。

下一大块是设置自带的树状图文件浏览器的。

后面的一堆xxmap是配置按键事件/映射的。

后面那一堆func是各种函数，能够实现一些简单的功能，比如TAB补全，F5代码运行。

综上，可以看出，vim配置文件`.vimrc`的结构大致==可以分为5个部分==，分别是

- 编辑器一般设置。包括格式，高亮，vim外观等
- 常量设置。通过预设一些常量来更改vim行为
- 插件设置。
- 按键映射绑定。更改/添加按键功能
- 函数。给编辑器添加自定义的功能

通过更改配置文件，我们可以十分简便地更改vim的外观，操作，代码高亮和补全等。并且可以非常轻松地迁移配置——复制`.vimrc`到新的地方即可。唯一的缺点是，你通常不知道都有什么可以更改的设置。在这一点上，**充分利用vim自带的帮助文档吧**：输入`:help`并回车即可查看。

### 常用配置

- `set wrap/set nowrap` 禁用换行
- `set number/set nonumber` 启用/禁用行号
- `set ai/set noai` 启用/禁用自动缩进，粘贴进代码自动缩进的话可以暂时关掉自动

## 0x04.常见问题

1. GVIM主界面乱码

修改`C:\Program Files (x86)\Vim\vim80\menu.vim`文件，增加

```vimrc
set encoding=utf-8
```

2. 改变字体大小

也是在上面的文件里，添加如下设置：

```vimrc
set guifont=Lucida\ Console:h14
```

如果没效果就把语句从文件末尾移到开头。

## 0x05.插件

这个后面再说吧，反正前面的一套下来也差不多够用了~~除非你想拿Vim当IDE用~~

## 0x06.写在最后

编辑器之神的称号源于它编辑文本贼6，而不是能变身All in one IDE（虽然确实可以这么干），写大型项目还是建议直接一步到胃用VS/IDEA。Vim一般也就写写单文件程序/改改配置之类，以及适用于一切要求快速编辑的场合~~比如做笔记~~。

Vim可以给你黑魔法，让你用令人目瞪口呆的速度写下你所想的东西，或者是更改需要更改的东西。最大限度地消除了编辑器和你的思想间的带宽限制之后，所剩下唯一的桎梏，就是——

你。
